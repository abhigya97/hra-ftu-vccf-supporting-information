## Butterfly Visualization Workflow

This project generates a comprehensive butterfly visualization using ASCT+B and Blood Vasculature data. The workflow involves two key Python scripts: `build-network.py` and `hra_butterfly.py`, which together process the data and render the visualization.

### Workflow Overview
1. **Data Compilation**:
   - `build-network.py` fetches and processes the latest ASCT+B JSON data to construct the anatomical partonomy network and its related nodes and edges.
   - Outputs from this script are saved in CSV format for use in subsequent steps.

2. **Visualization Generation**:
   - `hra_butterfly.py` uses the outputs from `build-network.py` to generate the butterfly visualization. This includes creating organ-specific graphs, pruning blood vasculature nodes, and overlaying anatomical and vascular networks.

### Detailed Scripts and their Roles

#### 1. `build-network.py`
This script constructs the base data required for butterfly visualization by fetching and processing the ASCT+B JSON data. The following steps outline its workflow:

1. **Fetch Data**: Retrieves the latest ASCT+B JSON data from the Human Reference Atlas (HRA) server.
2. **Node Creation**:
   - Generates unique IDs and labels for nodes representing anatomical structures (AS) and cell types (CT).
   - Includes metadata such as organ and ontology IDs.
3. **Edge Creation**:
   - Establishes relationships between nodes to form a tree-like network for each organ.
   - Ensures connectivity and correctness by adding missing edges for disconnected components.
4. **Output Generation**:
   - Saves the processed data into CSV files:
     - `asct-nodes.csv`: Contains details of nodes with columns for ID, name, type, organ, and ontology ID.
     - `asct-edges.csv`: Defines edges between nodes with columns for source, target, organ, and node types.
     - `asct-blood-vasculature-edges.csv`: Specifies edges for the blood vasculature network.

**Example Output (Nodes):**
| ID               | Name             | Type | Organ             | Ontology ID    |
|------------------|------------------|------|-------------------|----------------|
| UBERON:0013702   | Body             | AS   | Body              | UBERON:0013702 |
| UBERON:0000948   | Heart            | AS   | Blood Vasculature | UBERON:0000948 |

**Example Output (Edges):**
| Source           | Target           | Organ             | Source Type | Target Type |
|------------------|------------------|-------------------|-------------|-------------|
| UBERON:0013702   | UBERON:0000948   | Blood Vasculature | AS          | AS          |
| UBERON:0013702   | UBERON:0002113   | Kidney            | AS          | AS          |

#### 2. `hra_butterfly.py`
This script processes the CSV files generated by `build-network.py` to create the butterfly visualization. Key functionalities include:

1. **Load Data**:
   - Reads nodes and edges data from `asct-nodes.csv`, `asct-edges.csv`, and `asct-blood-vasculature-edges.csv`.
   - Filters out irrelevant organs and redundant edges.

2. **Organ-Specific Graphs**:
   - Creates graphs for individual organs by separating their nodes and edges.
   - Ensures connectivity and structure within each organ graph.

3. **Blood Vasculature Integration**:
   - Merges vascular network data with organ-specific networks.
   - Prunes redundant blood vasculature nodes to optimize the visualization.

4. **Vascular Network Layout**:
   - The vascular network is based on an additional input file, `vessel.csv`, which can be downloaded from [Zenodo](https://zenodo.org/records/7542316). This file has the following format:

|   |   BranchesFrom |                       Vessel |           ASID |    VesselType |      BodyPart |     BodyPartID |
|--:|---------------:|-----------------------------:|---------------:|--------------:|--------------:|---------------:|
| 0 |    left atrium |                  left atrium | UBERON:0002079 | heart chamber | heart chamber | UBERON:0004151 |
| 1 |    left atrium | left inferior pulmonary vein |       fma49913 |          vein |          lung | UBERON:0002048 |
| 2 |    left atrium | left superior pulmonary vein |       fma49916 |          vein |          lung | UBERON:0002048 |
| 3 |    left atrium |               pulmonary vein | UBERON:0002016 |          vein |          lung | UBERON:0002048 |
| 4 | pulmonary vein |     segmental pulmonary vein |        fma9411 |          vein |          lung | UBERON:0002048 |

   **Steps in Visualization:**
   1. Identify matching nodes between the vascular and organ networks based on the `ASID` and `ontology_id` fields.
   2. Create a full vascular network using the `BranchesFrom` and `Vessel` columns.
   3. Prune the network iteratively to ensure it connects correctly to the organ network.
   4. Use a spring layout algorithm to position nodes for visualization.
   5. Bundle edges for clarity using the `Datashader` package.

   Outputs from this step include PDF visualizations of the vascular network.

5. **Visualization Configuration**:
   - Generates Vega-based JSON configurations for the butterfly visualization.
   - Exports multiple versions of the visualization (e.g., full, female-only, male-only).

6. **Overlay Networks**:
   - Overlays anatomical and vascular networks to create a composite visualization.
   - Saves the final output as SVG and PDF files.

**Example Output (Final Visualization):**
- SVG Files:
  - `viz_v2.0/female_butterfly_wing.svg`
  - `viz_v2.0/male_butterfly_wing.svg`
- PDF Files:
  - `viz_v2.0/blood_viz_female.pdf`
  - `viz_v2.0/blood_viz_male.pdf`

### Input and Output Data
#### Inputs:
- **ASCT+B JSON Data**: Fetched by `build-network.py`.
- **Generated CSV Files**:
  - `asct-nodes.csv`
  - `asct-edges.csv`
  - `asct-blood-vasculature-edges.csv`
- **Additional Data Files**:
  - `vessel.csv`: Used for creating the vascular network.

#### Outputs:
- CSV files for nodes and edges.
- Vega configuration files for visualization.
- SVG and PDF files for final visual outputs, located in `viz_v2.0/`.

### Instructions for Running
1. **Set Up the Environment**:
   Run the `setup.sh` script to create and configure the Conda environment:
   ```bash
   ./setup.sh
   ```
   The script performs the following tasks:
   - Creates a Conda environment named `butterfly`.
   - Installs Python 3.11 and necessary dependencies.
   - Activates the `butterfly` environment.

2. **Run `build-network.py`**:
   ```bash
   python build-network.py
   ```
   - This script processes the data and generates CSV files in the `data/` directory.

3. **Download `vessel.csv`**:
   Download the vascular network data file from [Zenodo](https://zenodo.org/records/7542316) and place it in the `data/` directory.

4. **Run `hra_butterfly.py`**:
   ```bash
   python hra_butterfly.py
   ```
   - Outputs will be saved in the `viz_v2.0/` directory.

### Notes
- Both scripts require Python 3.11 or higher.
- Install dependencies using the `setup.sh` script.
- The generated visualization can be further refined using Adobe Illustrator or similar tools.

### Additional Details
- For more information, refer to the [HRA ASCT+B Reporter](https://humanatlas.io/asctb-reporter).
- Contact the project maintainers for assistance with data or scripts.
